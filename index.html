<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ­¡è¿åŠ å…¥æˆ‘å€‘çš„ LINE</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding-top: 50px;
      }
      .loader {
        border: 16px solid #f3f3f3;
        border-top: 16px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="status">
      <h2>æ­£åœ¨é©—è­‰æ¨è–¦è³‡è¨Š...</h2>
      <div class="loader"></div>
      <p>è«‹ç¨å€™ï¼Œå³å°‡ç‚ºæ‚¨å°å‘è‡³ LINE å®˜æ–¹å¸³è™Ÿ</p>
    </div>

    <script>
      const LIFF_ID = "2008384616-2W4GzZeB";
      const OA_URL = "https://line.me/R/ti/p/@638ccvfy";
      const API_URL =
        "https://line-flower-shop-f54f9c20b157.herokuapp.com/api/save_referral";

      function getRefFromUrl() {
        // 1) å…ˆæŠ“æ­£å¸¸ query: ?ref=KOL
        const params = new URLSearchParams(window.location.search || "");
        const directRef = params.get("ref");
        if (directRef && directRef.trim()) return directRef.trim();

        // 2) å†æŠ“ LIFF å¸¸è¦‹çš„åŒ…è£: ?liff.state=%3Fref%3DKOL
        const liffState = params.get("liff.state");
        if (liffState) {
          const decoded = decodeURIComponent(liffState); // å¯èƒ½æ˜¯ "?ref=KOL" æˆ– "something?ref=KOL"
          // æŠŠè£¡é¢çš„ query å†è§£æä¸€æ¬¡
          const q = decoded.includes("?") ? decoded.split("?").pop() : decoded;
          const innerParams = new URLSearchParams(
            q.startsWith("?") ? q.slice(1) : q
          );
          const innerRef = innerParams.get("ref");
          if (innerRef && innerRef.trim()) return innerRef.trim();
        }

        // 3) å°‘æ•¸æƒ…æ³ ref åœ¨ hash: https://.../#/?ref=KOL
        const hash = window.location.hash || "";
        if (hash.includes("ref=")) {
          const hashQuery = hash.includes("?")
            ? hash.split("?").pop()
            : hash.replace(/^#/, "");
          const hashParams = new URLSearchParams(hashQuery);
          const hashRef = hashParams.get("ref");
          if (hashRef && hashRef.trim()) return hashRef.trim();
        }

        return null;
      }

      function renderDebug(currentUserId, referrerId, stepText) {
        document.getElementById("status").innerHTML = `
          <div style="text-align:left; padding:20px;">
            <p>ğŸ‘¤ ç”¨æˆ¶: ${
              currentUserId ? currentUserId.substring(0, 8) + "..." : "å°šæœªå–å¾—"
            }</p>
            <p>ğŸ”— æ¨è–¦äºº: ${referrerId || "ç„¡"}</p>
            <p id="api-step">${stepText || ""}</p>
          </div>
        `;
      }

      async function postReferral(newUser, referrer) {
        // é¿å…ç¶²è·¯å¡æ­»ï¼šåŠ å€‹ timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ new_user: newUser, referrer }),
            signal: controller.signal,
          });
          return response.ok;
        } finally {
          clearTimeout(timeoutId);
        }
      }

      async function main() {
        try {
          // A) å…ˆåœ¨ã€Œç™»å…¥å‰ã€æŠ“ refï¼Œä¸¦æš«å­˜ï¼Œé¿å… login redirect å¾Œä¸Ÿå¤±
          const refFromUrl = getRefFromUrl();
          if (refFromUrl) {
            sessionStorage.setItem("referrerId", refFromUrl);
          }

          // B) åˆå§‹åŒ– LIFF
          await liff.init({ liffId: LIFF_ID });

          // C) æœªç™»å…¥å°±ç™»å…¥ï¼ˆredirectUri ç”¨ç•¶å‰ç¶²å€ï¼Œç›¡é‡ä¿ç•™åƒæ•¸ï¼‰
          if (!liff.isLoggedIn()) {
            renderDebug(null, refFromUrl, "ğŸ” å°šæœªç™»å…¥ï¼Œæº–å‚™ç™»å…¥...");
            liff.login({ redirectUri: window.location.href });
            return;
          }

          // D) å–å¾—ä½¿ç”¨è€… ID
          const profile = await liff.getProfile();
          const currentUserId = profile.userId;

          // E) ç™»å…¥å¾Œå†æ‹¿ä¸€æ¬¡ refï¼ˆå„ªå…ˆ URLï¼Œå…¶æ¬¡ sessionStorageï¼‰
          const referrerId =
            getRefFromUrl() || sessionStorage.getItem("referrerId");

          renderDebug(currentUserId, referrerId, "â³ æº–å‚™é€šè¨Š...");

          // F) å¯«å…¥æ¨è–¦é—œä¿‚
          if (referrerId && currentUserId && referrerId !== currentUserId) {
            document.getElementById("api-step").innerText =
              "ğŸš€ æ­£åœ¨å¯«å…¥æ¨è–¦ç´€éŒ„...";

            try {
              const ok = await postReferral(currentUserId, referrerId);

              if (ok) {
                document.getElementById("api-step").innerText =
                  "âœ… ç´€éŒ„æˆåŠŸï¼æ­£åœ¨å°å‘...";
                console.log("Save Success");
              } else {
                document.getElementById("api-step").innerText =
                  "âš ï¸ ç´€éŒ„å¤±æ•—ï¼Œä½†å³å°‡è·³è½‰...";
                console.warn("Save Failed: response not ok");
              }
            } catch (err) {
              console.error("API Error:", err);
              document.getElementById("api-step").innerText =
                "âŒ ç¶²è·¯éŒ¯èª¤æˆ–é€¾æ™‚ï¼Œå³å°‡è·³è½‰...";
            }
          } else {
            document.getElementById("api-step").innerText =
              "â„¹ï¸ ç„¡æ¨è–¦è³‡è¨Šï¼Œç›´æ¥è·³è½‰...";
          }

          // G) æœ€å¾Œè·³è½‰ï¼ˆçŸ­å»¶é²ï¼‰
          setTimeout(() => {
            window.location.replace(OA_URL);
          }, 800);
        } catch (error) {
          console.error(error);
          document.getElementById("status").innerHTML =
            "<h2>ç™¼ç”ŸéŒ¯èª¤</h2><pre style='text-align:left; padding:12px; white-space:pre-wrap;'>" +
            String(error) +
            "</pre>";
        }
      }

      main();
    </script>
  </body>
</html>
